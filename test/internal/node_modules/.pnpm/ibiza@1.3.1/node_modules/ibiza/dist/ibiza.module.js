import{useRef as e,useReducer as t,useCallback as r,useEffect as n,useMemo as o,useDebugValue as i}from"react";import u from"micro-memoize";import{deepEqual as c}from"fast-equals";function f(){return f=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},f.apply(this,arguments)}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function l(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function p(e,t,r){return p=l()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&a(o,r.prototype),o},p.apply(null,arguments)}function h(e){var t="function"==typeof Map?new Map:void 0;return h=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return p(e,arguments,s(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),a(r,e)},h(e)}function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function v(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return y(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?y(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var b=0;function d(e){return"__private_"+b+++"_"+e}function O(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var g=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,j=/^\w*$/,m=/^\./,w=/^(?:0|[1-9]\d*)$/,P=/\\(\\)?/g,x=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g;function S(e){return"[object Date]"===Object.prototype.toString.call(e)}function _(e){if("[object Object]"!==Object.prototype.toString.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function z(e,t){for(var r=0,n=(t=I(t,e)?[t]:C(t)).length;null!=e&&r<n;)e=e[A(t[r++])];return r&&r==n?e:void 0}function k(e,t,r){var n=e[t];Object.prototype.hasOwnProperty.call(e,t)&&function(e,t){return e===t||e!=e&&t!=t}(n,r)&&(void 0!==r||t in e)||(e[t]=r)}function F(e,t){return!!(t=null==t?9007199254740991:t)&&("number"==typeof e||w.test(e))&&e>-1&&e%1==0&&e<t}function E(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function A(e){if("string"==typeof e||R(e))return e;var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t}function I(e,t){if(Array.isArray(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!R(e))||j.test(e)||!g.test(e)||null!=t&&e in Object(t)}function R(e){return"symbol"==typeof e||!!e&&"object"==typeof e&&"[object Symbol]"==Object.prototype.toString.call(e)}function C(e){return Array.isArray(e)?e:N(e)}var N=u(function(e){e=function(e){if(null==e)return"";if("string"==typeof e)return e;if(R(e))return Symbol.prototype.toString.call(e);var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t}(e);var t=[];return m.test(e)&&t.push(""),e.replace(x,function(e,r,n,o){t.push(n?o.replace(P,"$1"):r||e)}),t}),V=["suspense"],M=Symbol("ibizaIsAccessor"),T=Symbol("ibizaIsQuery"),W=Symbol("ibizaQueryFunction"),$=/*#__PURE__*/d("setListeners"),D=/*#__PURE__*/d("state"),G=/*#__PURE__*/d("proxyCache"),H=/*#__PURE__*/d("mergedObjects"),q=/*#__PURE__*/d("customFetchFn"),K=/*#__PURE__*/d("defaultFetchFn"),B=/*#__PURE__*/d("proxyOf");function L(e,t){var r=this;if(void 0===t&&(t=null),e.isHookProxy)return e;if(O(this,G)[G].has(e))return O(this,G)[G].get(e);function n(e){return e?0===e.indexOf("/")?e:t?[t,e].join("."):e:t}var o=this,i=new Proxy(e,{get:function(e,i,u){var c,s;if("isProxy"===i)return!0;if("isStoreProxy"===i)return!0;if("isHookProxy"===i)return!1;if("__path"===i)return t;if("__fetcher"===i)return function(e){if(0!==e.indexOf("/")){var t=n(e);0===t.indexOf("/")&&(e=t.split(".")[0])}if(Object.prototype.hasOwnProperty.call(r.fetches,e))return r.fetches[e]}(t);if("__raw"===i)return t?z(o.rawState,t):o.rawState;if("save"===i){var a=n(i);if(0===a.indexOf("/"))return function(e,t){void 0===e&&(e={}),void 0===t&&(t={});try{if("string"!=typeof e){t=e;var r=a.split(".");e=r[0]}return Promise.resolve(o.fetch(e,f({method:"patch"},t))).then(function(t){return null!==t&&(o.state[e]=t),t})}catch(e){return Promise.reject(e)}}}if("refetch"===i){var l=n(i);if(0===l.indexOf("/"))return function(){try{var e=l.split(".")[0];return Promise.resolve(o.fetch(e)).then(function(t){return null!==t&&(o.state[e]=t),t})}catch(e){return Promise.reject(e)}}}if("length"!==i&&!Object.prototype.hasOwnProperty.call(e,i)&&(Object.getPrototypeOf(e)[i]||"symbol"==typeof i))return Reflect.get(e,i,u);var p=n(i),h=Reflect.get(e,i,u);if(Object.isFrozen(e)||null!==h&&"object"==typeof h&&Object.isFrozen(h))return h;var y=function(e){return!Object.prototype.hasOwnProperty.call(o.fetches,e)||o.fetches[e].fetch},v=function(e){if(Object.prototype.hasOwnProperty.call(o.fetches,e)&&o.fetches[e].error)throw o.fetches[i].error};if(null!=(c=h)&&c[M])return h(e,i,u);if(null!=(s=h)&&s[T]){var b=h[W].call(u);if(v(b),y(b)){var d=o.fetch(b,{suspense:!0});Object.defineProperty(d,T,{value:!0}),Object.defineProperty(d,W,{value:h[W]}),this.set(e,i,d,u),h=d}else Object.prototype.hasOwnProperty.call(o.fetches,b)&&(h=o.fetches[b].response)}else if(0===i.indexOf("/"))v(i),y(i)&&(h=o.fetch(i,{suspense:!0}),this.set(e,i,h,u));else if(0===p.indexOf("/")){var g=p.split("."),j=g[0],m=g.slice(1).join(".");if(v(j),y(j)){var w=o.fetch(j,{suspense:!0});o.state[j]=w,h=z(w,m)}}return null===h||"object"!=typeof h||S(h)?h:O(o,B)[B](h,p)},set:function(e,t,r,i){if(e.isProxy&&console.warn("[ibiza] Attempting to set a property (%s) on proxied object",t,e),Object.isFrozen(e))throw new TypeError("Cannot mutate '"+t+"'. Object is frozen!");var u=Reflect.get(e,t,i),c=Reflect.set(e,t,r,i);if(c&&(u=Y(u),"length"===t||!Object.is(u,r))){var f=n(t);Q.debug&&(console.groupCollapsed("[ibiza] Mutated %o",f),console.info({previousValue:u,value:r}),console.groupEnd()),o.publishChange({target:e,prop:t,path:f,previousValue:u,value:r})}return c},deleteProperty:function(e,t){var r=Reflect.get(e,t),i=Reflect.deleteProperty(e,t);return i&&o.publishChange({target:e,prop:t,path:n(t),previousValue:Y(r)}),i}});return O(this,G)[G].set(e,i),i}var Q=new(/*#__PURE__*/function(){function e(){Object.defineProperty(this,B,{value:L}),this.debug="development"===process.env.NODE_ENV,this.fetches={},this.modelInitializers={},this.modelOptions={},Object.defineProperty(this,$,{writable:!0,value:new Set}),Object.defineProperty(this,D,{writable:!0,value:{}}),Object.defineProperty(this,G,{writable:!0,value:new WeakMap}),Object.defineProperty(this,H,{writable:!0,value:new WeakMap}),Object.defineProperty(this,q,{writable:!0,value:void 0}),Object.defineProperty(this,K,{writable:!0,value:function(e,t){var r=/*#__PURE__*/function(e){var t,r;function n(){return e.apply(this,arguments)||this}return r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,a(t,r),n}(/*#__PURE__*/h(Error)),n=new URL(e,location.origin);return fetch(new Request(n),t).then(function(e){if(!e.ok)throw new r(e.statusText);return 204===e.status?null:e.json()})}}),this.reset()}var t,r,n=e.prototype;return n.merge=function(e){if(!_(e))throw new TypeError("IbizaStore#merge expects a plain object to merge");O(this,H)[H].has(e)||(O(this,H)[H].set(e,!0),Z(this.state,e))},n.listenForChanges=function(e){var t=this;return O(this,$)[$].add(e),function(){return t.unlistenForChanges(e)}},n.unlistenForChanges=function(e){O(this,$)[$].delete(e)},n.publishChange=function(){for(var e,t=v(O(this,$)[$]);!(e=t()).done;){var r=e.value;r.apply(void 0,arguments)}},n.reset=function(){O(this,D)[D]={},O(this,H)[H]=new WeakMap,O(this,G)[G]=new WeakMap,O(this,q)[q]=void 0,O(this,$)[$]=new Set,this.fetches={},this.modelInitializers={},this.modelOptions={},this.debug="development"===process.env.NODE_ENV},n.fetch=function(e,t){var r,n=this;void 0===t&&(t={});var o=t.suspense,i=function(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(o[r]=e[r]);return o}(t,V),u=function(t){return n.fetches[e].status="success",null===t?t:n.fetches[e].response=e in n.modelInitializers?n.modelInitializers[e](t):t},c=((null==(r=this.modelOptions[e])?void 0:r.fetcher)||this.fetchFn).bind(this.state);if(!o)return c(e,i).then(u);if(this.fetches[e]){if(this.fetches[e].error)throw delete this.fetches[e].fetch,this.fetches[e].error;if(this.fetches[e].response)return delete this.fetches[e].fetch,this.fetches[e].response}else this.fetches[e]={status:"start",fetch:c(e,i).then(u).catch(function(t){n.fetches[e].status="error",n.fetches[e].error=t})};throw this.fetches[e].fetch},t=e,(r=[{key:"state",get:function(){return O(this,B)[B](O(this,D)[D])},set:function(e){O(this,G)[G]=new WeakMap,O(this,D)[D]=e}},{key:"rawState",get:function(){return O(this,D)[D]}},{key:"fetchFn",get:function(){return O(this,q)[q]||O(this,K)[K]},set:function(e){O(this,q)[q]=e}}])&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}()),U=Q;function Y(e){return e&&e.isProxy?e.__path?z(Q.rawState,e.__path):Q.rawState:e}function Z(e,t){for(var r=0,n=Object.keys(t);r<n.length;r++){var o=n[r],i=Object.getOwnPropertyDescriptor(t,o),u=Object.prototype.hasOwnProperty.call(i,"value");if(Object.prototype.hasOwnProperty.call(e,o)?(u&&"object"!=typeof i.value||Array.isArray(i.value))&&Object.defineProperty(e,o,i):Object.defineProperty(e,o,i),u){var c=e[o];_(i.value)?e[o]=Z(c,i.value):Array.isArray(i.value)&&(e[o]=i.value.map(function(e,t,r){return _(e)?Z(r[t],e):e}))}}return e}function J(e,t,r,n,o){var i;if("string"==typeof e?(i=z(U.state,e)||{},t=e):i=e||U.state,n.has(i))return n.get(i);if(null===i)return i;if(i.isHookProxy)return i;var u=new Proxy(i,{get:function(e,o){if("isProxy"===o)return!0;if("isStoreProxy"===o)return!1;if("isHookProxy"===o)return!0;if("$root"===o)return J(null,null,r,n);if("$model"===o){var i=c(o).split("."),u=i[0];return J(u,null,r,n)}var f=Object.prototype.hasOwnProperty.call(e,o),s=Reflect.get.apply(Reflect,arguments);if(Object.isFrozen(e)||null!==s&&"object"==typeof s&&Object.isFrozen(s))return Y(s);if("__path"===o||"save"===o&&"function"==typeof s)return s;if("length"!==o&&!f&&(Object.getPrototypeOf(e)[o]||"symbol"==typeof o))return s;if("function"==typeof s&&f)return s.bind(J(e,t,r,n),J(null,null,r,n));var a=c(o);return null===s||"object"!=typeof s||S(s)?(r(a,"get"),s):J(s,a,r,n)},ownKeys:function(){return r(c(),"ownKeys"),Reflect.ownKeys.apply(Reflect,arguments)}});function c(e){return e?0===e.indexOf("/")?e:t?[t,e].join("."):e:t}return n.set(i,u),u}function X(i,u){var c=function(){var t=e();if("production"!==process.env.NODE_ENV){var r=(new Error).stack.split("\n").find(function(e){return/^[A-Z]/.test(e.trim().split(" ")[1])});t.current=null==r?void 0:r.trim().split(" ")[1]}return t}(),f=t(function(e){return e+1},0)[1],s=e([]),a=e(new WeakMap),l=e(i),p=e(),h=r(function(e){var t=e.path,r=e.previousValue,n=e.value,o=function(e,t){if(t.includes(e))return"exact";for(var r,n=!1,o=v(t);!(r=o()).done;){var i=r.value;if(e.startsWith(i)){n="child";break}if(i.startsWith(e+".")){n="parent";break}}return n}(t,s.current);if(o)if("parent"===o){var i=ee(t,s.current,n,r);i&&(U.debug&&console.debug("[ibiza] <%s> rerendering on child %o of %o",c.current,i,t),f())}else U.debug&&console.debug("[ibiza] <%s> rerendering on %o (%s)",c.current,t,o),f()},[]),y=r(function(e){s.current.includes(e)||(U.debug&&console.debug("[ibiza] <%s> tracking %o",c.current,e),s.current.push(e),U.listenForChanges(h))},[c,h]);if(void 0!==typeof l.current)if(_(l.current))U.merge(l.current),l.current=void 0;else if("function"==typeof l.current)U.merge(l.current(U.state)),l.current=void 0;else if("string"==typeof l.current){var b;p.current=l.current,l.current=void 0,u&&(b=0===p.current.indexOf("/")?"function"==typeof u?{}:u:"function"==typeof u?u(z(U.state,p.current)||{}):u,U.merge(function(e,t,r){if(null==e)return e;if(!E(e))return e;for(var n=-1,o=e,i=(t=I(t,e)?[t]:C(t)).length,u=i-1;null!=o&&++n<i;){var c=A(t[n]),f=r;if(n!=u){var s=o[c];f=E(s)?s:F(t[n+1])?[]:{}}k(o,c,f),o=o[c]}return e}({},p.current,b)))}n(function(){return function(){return U.unlistenForChanges(h)}},[]);var d=o(function(){var e=null,t=null;if(p.current){var r=z(U.state,e=p.current);if(null!=r&&"object"!=typeof r&&"function"!=typeof r){var n=e.split(".").reverse();t=n[0],e=n.slice(1).reverse().join(".")||null}}return[e,t]},[]),O=d[1],g=J(d[0]||null,null,y,a.current);return O?g[O]:g}"production"!==process.env.NODE_ENV&&(window.ibizaStore=Q);var ee=u(function(e,t,r,n){return t.find(function(t){if(!t.startsWith(e+"."))return!1;var o=t.slice(e.length+1),i=o.includes("."),u=void 0;null!=r&&(u=i?z(r,o):r[o]);var f=void 0;return null!=n&&(f=i?z(n,o):n[o]),S(u)&&S(f)?u.getTime()!==f.getTime():"object"==typeof f&&"object"==typeof u?!c(u,f):!Object.is(u,f)})},{isEqual:c,maxSize:Number.POSITIVE_INFINITY});function te(e,t,r){return void 0===t&&(t={}),void 0===r&&(r={}),function(n,o){if(i(e),"string"!=typeof n&&(o=n,n=void 0),e in U.state==0)if("function"==typeof t){var u=U.modelInitializers[e]=function(e){return t(e,o)};0!==e.indexOf("/")&&(U.state[e]=u(U.state[e]))}else U.state[e]=t;return U.modelOptions[e]=r,X(n?[e,n].join("."):e)}}function re(e,t,r){void 0===r&&(r={});var n=!1,o=Object.prototype.hasOwnProperty.call(e,t)?e[t]:r.initialValue,i=function(e){o=e,n=!0};Object.defineProperty(e,t,{get:function(){return r.onGet?r.onGet.call(this,o):o},set:function(e){var t;null==(t=r.onSet)||t.call(this,o,e,i),n?n=!1:o=e}})}function ne(e){function t(t,r,n){var o=!1,i=e.initialValue,u=function(e){i=e,o=!0};return Object.defineProperty(t,r,{get:function(){return e.onGet?e.onGet.call(this,i):i},set:function(t){var r;null==(r=e.onSet)||r.call(this,i,t,u),o?o=!1:i=t}}),Reflect.get(t,r,n)}return void 0===e&&(e={}),Object.defineProperty(t,M,{value:!0}),t}function oe(e){var t={};return Object.defineProperty(t,T,{value:!0}),Object.defineProperty(t,W,{value:e}),t}function ie(e){if(Object.isFrozen(e))return e;if(!Array.isArray(e)&&Object.getPrototypeOf(e)!==Object.getPrototypeOf({}))throw new Error("Ibiza#freeze only supports plain objects, arrays, and primitives");return Object.freeze(e),Object.keys(e).forEach(function(t){ie(e[t])}),e}export{ne as accessor,re as createAccessor,te as createModel,ie as freeze,oe as query,Y as rawStateOf,U as store,X as useIbiza};
//# sourceMappingURL=ibiza.module.js.map
