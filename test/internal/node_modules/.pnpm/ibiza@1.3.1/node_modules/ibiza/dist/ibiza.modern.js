import{useRef as e,useReducer as t,useCallback as r,useEffect as n,useMemo as o,useDebugValue as i}from"react";import s from"micro-memoize";import{deepEqual as c}from"fast-equals";const u=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,l=/^\w*$/,f=/^\./,a=/^(?:0|[1-9]\d*)$/,p=/\\(\\)?/g,h=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g;function y(e){return"[object Date]"===Object.prototype.toString.call(e)}function b(e){if("[object Object]"!==Object.prototype.toString.call(e))return!1;const t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function d(e,t){let r=0;const n=(t=w(t,e)?[t]:P(t)).length;for(;null!=e&&r<n;)e=e[v(t[r++])];return r&&r==n?e:void 0}function O(e,t,r){const n=e[t];Object.prototype.hasOwnProperty.call(e,t)&&function(e,t){return e===t||e!=e&&t!=t}(n,r)&&(void 0!==r||t in e)||(e[t]=r)}function g(e,t){return!!(t=null==t?9007199254740991:t)&&("number"==typeof e||a.test(e))&&e>-1&&e%1==0&&e<t}function j(e){const t=typeof e;return!!e&&("object"==t||"function"==t)}function v(e){if("string"==typeof e||m(e))return e;const t=e+"";return"0"==t&&1/e==-Infinity?"-0":t}function w(e,t){if(Array.isArray(e))return!1;const r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!m(e))||l.test(e)||!u.test(e)||null!=t&&e in Object(t)}function m(e){return"symbol"==typeof e||!!e&&"object"==typeof e&&"[object Symbol]"==Object.prototype.toString.call(e)}function P(e){return Array.isArray(e)?e:x(e)}const x=s(function(e){e=function(e){if(null==e)return"";if("string"==typeof e)return e;if(m(e))return Symbol.prototype.toString.call(e);const t=e+"";return"0"==t&&1/e==-Infinity?"-0":t}(e);let t=[];return f.test(e)&&t.push(""),e.replace(h,function(e,r,n,o){t.push(n?o.replace(p,"$1"):r||e)}),t});function z(){return z=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},z.apply(this,arguments)}var S=0;function _(e){return"__private_"+S+++"_"+e}function F(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}const k=["suspense"],E=Symbol("ibizaIsAccessor"),I=Symbol("ibizaIsQuery"),A=Symbol("ibizaQueryFunction");var C=/*#__PURE__*/_("setListeners"),N=/*#__PURE__*/_("state"),R=/*#__PURE__*/_("proxyCache"),V=/*#__PURE__*/_("mergedObjects"),W=/*#__PURE__*/_("customFetchFn"),$=/*#__PURE__*/_("defaultFetchFn"),T=/*#__PURE__*/_("proxyOf");function M(e,t=null){if(e.isHookProxy)return e;if(F(this,R)[R].has(e))return F(this,R)[R].get(e);function r(e){return e?0===e.indexOf("/")?e:t?[t,e].join("."):e:t}const n=e=>{if(0!==e.indexOf("/")){const t=r(e);0===t.indexOf("/")&&(e=t.split(".")[0])}if(Object.prototype.hasOwnProperty.call(this.fetches,e))return this.fetches[e]},o=this,i=new Proxy(e,{get(e,i,s){var c,u;if("isProxy"===i)return!0;if("isStoreProxy"===i)return!0;if("isHookProxy"===i)return!1;if("__path"===i)return t;if("__fetcher"===i)return n(t);if("__raw"===i)return t?d(o.rawState,t):o.rawState;if("save"===i){const e=r(i);if(0===e.indexOf("/"))return async(t={},r={})=>{"string"!=typeof t&&(r=t,[t]=e.split("."));const n=await o.fetch(t,z({method:"patch"},r));return null!==n&&(o.state[t]=n),n}}if("refetch"===i){const e=r(i);if(0===e.indexOf("/"))return async()=>{const[t]=e.split("."),r=await o.fetch(t);return null!==r&&(o.state[t]=r),r}}if("length"!==i&&!Object.prototype.hasOwnProperty.call(e,i)&&(Object.getPrototypeOf(e)[i]||"symbol"==typeof i))return Reflect.get(e,i,s);const l=r(i);let f=Reflect.get(e,i,s);if(Object.isFrozen(e)||null!==f&&"object"==typeof f&&Object.isFrozen(f))return f;const a=e=>!Object.prototype.hasOwnProperty.call(o.fetches,e)||o.fetches[e].fetch,p=e=>{if(Object.prototype.hasOwnProperty.call(o.fetches,e)&&o.fetches[e].error)throw o.fetches[i].error};if(null!=(c=f)&&c[E])return f(e,i,s);if(null!=(u=f)&&u[I]){const t=f[A].call(s);if(p(t),a(t)){const r=o.fetch(t,{suspense:!0});Object.defineProperty(r,I,{value:!0}),Object.defineProperty(r,A,{value:f[A]}),this.set(e,i,r,s),f=r}else Object.prototype.hasOwnProperty.call(o.fetches,t)&&(f=o.fetches[t].response)}else if(0===i.indexOf("/"))p(i),a(i)&&(f=o.fetch(i,{suspense:!0}),this.set(e,i,f,s));else if(0===l.indexOf("/")){const[e,...t]=l.split("."),r=t.join(".");if(p(e),a(e)){const t=o.fetch(e,{suspense:!0});o.state[e]=t,f=d(t,r)}}return null===f||"object"!=typeof f||y(f)?f:F(o,T)[T](f,l)},set(e,t,n,i){if(e.isProxy&&console.warn("[ibiza] Attempting to set a property (%s) on proxied object",t,e),Object.isFrozen(e))throw new TypeError(`Cannot mutate '${t}'. Object is frozen!`);let s=Reflect.get(e,t,i);const c=Reflect.set(e,t,n,i);if(c&&(s=H(s),"length"===t||!Object.is(s,n))){const i=r(t);D.debug&&(console.groupCollapsed("[ibiza] Mutated %o",i),console.info({previousValue:s,value:n}),console.groupEnd()),o.publishChange({target:e,prop:t,path:i,previousValue:s,value:n})}return c},deleteProperty(e,t){const n=Reflect.get(e,t),i=Reflect.deleteProperty(e,t);return i&&o.publishChange({target:e,prop:t,path:r(t),previousValue:H(n)}),i}});return F(this,R)[R].set(e,i),i}const D=new class{constructor(){Object.defineProperty(this,T,{value:M}),this.debug="development"===process.env.NODE_ENV,this.fetches={},this.modelInitializers={},this.modelOptions={},Object.defineProperty(this,C,{writable:!0,value:new Set}),Object.defineProperty(this,N,{writable:!0,value:{}}),Object.defineProperty(this,R,{writable:!0,value:new WeakMap}),Object.defineProperty(this,V,{writable:!0,value:new WeakMap}),Object.defineProperty(this,W,{writable:!0,value:void 0}),Object.defineProperty(this,$,{writable:!0,value:(e,t)=>{class r extends Error{}const n=new URL(e,location.origin);return fetch(new Request(n),t).then(e=>{if(!e.ok)throw new r(e.statusText);return 204===e.status?null:e.json()})}}),this.reset()}set state(e){F(this,R)[R]=new WeakMap,F(this,N)[N]=e}get state(){return F(this,T)[T](F(this,N)[N])}get rawState(){return F(this,N)[N]}merge(e){if(!b(e))throw new TypeError("IbizaStore#merge expects a plain object to merge");F(this,V)[V].has(e)||(F(this,V)[V].set(e,!0),q(this.state,e))}listenForChanges(e){return F(this,C)[C].add(e),()=>this.unlistenForChanges(e)}unlistenForChanges(e){F(this,C)[C].delete(e)}publishChange(){for(let e of F(this,C)[C])e(...arguments)}reset(){F(this,N)[N]={},F(this,V)[V]=new WeakMap,F(this,R)[R]=new WeakMap,F(this,W)[W]=void 0,F(this,C)[C]=new Set,this.fetches={},this.modelInitializers={},this.modelOptions={},this.debug="development"===process.env.NODE_ENV}get fetchFn(){return F(this,W)[W]||F(this,$)[$]}set fetchFn(e){F(this,W)[W]=e}fetch(e,t={}){var r;const{suspense:n}=t,o=function(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(o[r]=e[r]);return o}(t,k),i=t=>(this.fetches[e].status="success",null===t?t:this.fetches[e].response=e in this.modelInitializers?this.modelInitializers[e](t):t),s=((null==(r=this.modelOptions[e])?void 0:r.fetcher)||this.fetchFn).bind(this.state);if(!n)return s(e,o).then(i);if(this.fetches[e]){if(this.fetches[e].error)throw delete this.fetches[e].fetch,this.fetches[e].error;if(this.fetches[e].response)return delete this.fetches[e].fetch,this.fetches[e].response}else this.fetches[e]={status:"start",fetch:s(e,o).then(i).catch(t=>{this.fetches[e].status="error",this.fetches[e].error=t})};throw this.fetches[e].fetch}};var G=D;function H(e){return e&&e.isProxy?e.__path?d(D.rawState,e.__path):D.rawState:e}function q(e,t){const r=Object.keys(t);for(const n of r){const r=Object.getOwnPropertyDescriptor(t,n),o=Object.prototype.hasOwnProperty.call(r,"value");if(Object.prototype.hasOwnProperty.call(e,n)?(o&&"object"!=typeof r.value||Array.isArray(r.value))&&Object.defineProperty(e,n,r):Object.defineProperty(e,n,r),o){const t=e[n];b(r.value)?e[n]=q(t,r.value):Array.isArray(r.value)&&(e[n]=r.value.map((e,t,r)=>b(e)?q(r[t],e):e))}}return e}function K(e,t,r,n,o){let i;if("string"==typeof e?(i=d(G.state,e)||{},t=e):i=e||G.state,n.has(i))return n.get(i);if(null===i)return i;if(i.isHookProxy)return i;const s=new Proxy(i,{get(e,o){if("isProxy"===o)return!0;if("isStoreProxy"===o)return!1;if("isHookProxy"===o)return!0;if("$root"===o)return K(null,null,r,n);if("$model"===o){const[e]=c(o).split(".");return K(e,null,r,n)}const i=Object.prototype.hasOwnProperty.call(e,o);let s=Reflect.get(...arguments);if(Object.isFrozen(e)||null!==s&&"object"==typeof s&&Object.isFrozen(s))return H(s);if("__path"===o||"save"===o&&"function"==typeof s)return s;if("length"!==o&&!i&&(Object.getPrototypeOf(e)[o]||"symbol"==typeof o))return s;if("function"==typeof s&&i)return s.bind(K(e,t,r,n),K(null,null,r,n));const u=c(o);return null===s||"object"!=typeof s||y(s)?(r(u,"get"),s):K(s,u,r,n)},ownKeys(){return r(c(),"ownKeys"),Reflect.ownKeys(...arguments)}});function c(e){return e?0===e.indexOf("/")?e:t?[t,e].join("."):e:t}return n.set(i,s),s}function L(i,s){const c=(()=>{const t=e();if("production"!==process.env.NODE_ENV){const e=(new Error).stack.split("\n").find(e=>/^[A-Z]/.test(e.trim().split(" ")[1]));t.current=null==e?void 0:e.trim().split(" ")[1]}return t})(),[,u]=t(e=>e+1,0),l=e([]),f=e(new WeakMap),a=e(i),p=e(),h=r(({path:e,previousValue:t,value:r})=>{const n=function(e,t){if(t.includes(e))return"exact";let r=!1;for(const n of t){if(e.startsWith(n)){r="child";break}if(n.startsWith(`${e}.`)){r="parent";break}}return r}(e,l.current);if(n)if("parent"===n){const n=Q(e,l.current,r,t);n&&(G.debug&&console.debug("[ibiza] <%s> rerendering on child %o of %o",c.current,n,e),u())}else G.debug&&console.debug("[ibiza] <%s> rerendering on %o (%s)",c.current,e,n),u()},[]),y=r(e=>{l.current.includes(e)||(G.debug&&console.debug("[ibiza] <%s> tracking %o",c.current,e),l.current.push(e),G.listenForChanges(h))},[c,h]);if(void 0!==typeof a.current)if(b(a.current))G.merge(a.current),a.current=void 0;else if("function"==typeof a.current)G.merge(a.current(G.state)),a.current=void 0;else if("string"==typeof a.current&&(p.current=a.current,a.current=void 0,s)){let e;e=0===p.current.indexOf("/")?"function"==typeof s?{}:s:"function"==typeof s?s(d(G.state,p.current)||{}):s,G.merge(function(e,t,r){if(null==e)return e;if(!j(e))return e;let n=-1,o=e;const i=(t=w(t,e)?[t]:P(t)).length,s=i-1;for(;null!=o&&++n<i;){const e=v(t[n]);let i=r;if(n!=s){const r=o[e];i=j(r)?r:g(t[n+1])?[]:{}}O(o,e,i),o=o[e]}return e}({},p.current,e))}n(()=>()=>G.unlistenForChanges(h),[]);const[m,x]=o(()=>{let e=null,t=null;if(p.current){e=p.current;const r=d(G.state,e);if(null!=r&&"object"!=typeof r&&"function"!=typeof r){const[r,...n]=e.split(".").reverse();t=r,e=n.reverse().join(".")||null}}return[e,t]},[]),z=K(m||null,null,y,f.current);return x?z[x]:z}"production"!==process.env.NODE_ENV&&(window.ibizaStore=D);const Q=s(function(e,t,r,n){return t.find(t=>{if(!t.startsWith(`${e}.`))return!1;const o=t.slice(e.length+1),i=o.includes(".");let s,u;return null!=r&&(s=i?d(r,o):r[o]),null!=n&&(u=i?d(n,o):n[o]),y(s)&&y(u)?s.getTime()!==u.getTime():"object"==typeof u&&"object"==typeof s?!c(s,u):!Object.is(s,u)})},{isEqual:c,maxSize:Number.POSITIVE_INFINITY});function U(e,t={},r={}){return function(n,o){if(i(e),"string"!=typeof n&&(o=n,n=void 0),e in G.state==0)if("function"==typeof t){const r=G.modelInitializers[e]=e=>t(e,o);0!==e.indexOf("/")&&(G.state[e]=r(G.state[e]))}else G.state[e]=t;return G.modelOptions[e]=r,L(n?[e,n].join("."):e)}}function Y(e,t,r={}){let n=!1,o=Object.prototype.hasOwnProperty.call(e,t)?e[t]:r.initialValue;const i=e=>{o=e,n=!0};Object.defineProperty(e,t,{get(){return r.onGet?r.onGet.call(this,o):o},set(e){var t;null==(t=r.onSet)||t.call(this,o,e,i),n?n=!1:o=e}})}function Z(e={}){function t(t,r,n){let o=!1,i=e.initialValue;const s=e=>{i=e,o=!0};return Object.defineProperty(t,r,{get(){return e.onGet?e.onGet.call(this,i):i},set(t){var r;null==(r=e.onSet)||r.call(this,i,t,s),o?o=!1:i=t}}),Reflect.get(t,r,n)}return Object.defineProperty(t,E,{value:!0}),t}function B(e){const t={};return Object.defineProperty(t,I,{value:!0}),Object.defineProperty(t,A,{value:e}),t}function J(e){if(Object.isFrozen(e))return e;if(!Array.isArray(e)&&Object.getPrototypeOf(e)!==Object.getPrototypeOf({}))throw new Error("Ibiza#freeze only supports plain objects, arrays, and primitives");return Object.freeze(e),Object.keys(e).forEach(t=>{J(e[t])}),e}export{Z as accessor,Y as createAccessor,U as createModel,J as freeze,B as query,H as rawStateOf,G as store,L as useIbiza};
//# sourceMappingURL=ibiza.modern.js.map
