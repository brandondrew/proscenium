var e=require("react"),t=require("micro-memoize"),r=require("fast-equals");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=/*#__PURE__*/n(t);function i(){return i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},i.apply(this,arguments)}function u(e){return u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},u(e)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function s(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function f(e,t,r){return f=s()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&c(o,r.prototype),o},f.apply(null,arguments)}function a(e){var t="function"==typeof Map?new Map:void 0;return a=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return f(e,arguments,u(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),c(r,e)},a(e)}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function p(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return l(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?l(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var h=0;function y(e){return"__private_"+h+++"_"+e}function v(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var b=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,d=/^\w*$/,O=/^\./,g=/^(?:0|[1-9]\d*)$/,j=/\\(\\)?/g,w=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g;function m(e){return"[object Date]"===Object.prototype.toString.call(e)}function P(e){if("[object Object]"!==Object.prototype.toString.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function x(e,t){for(var r=0,n=(t=R(t,e)?[t]:F(t)).length;null!=e&&r<n;)e=e[k(t[r++])];return r&&r==n?e:void 0}function S(e,t,r){var n=e[t];Object.prototype.hasOwnProperty.call(e,t)&&function(e,t){return e===t||e!=e&&t!=t}(n,r)&&(void 0!==r||t in e)||(e[t]=r)}function z(e,t){return!!(t=null==t?9007199254740991:t)&&("number"==typeof e||g.test(e))&&e>-1&&e%1==0&&e<t}function _(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function k(e){if("string"==typeof e||E(e))return e;var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t}function R(e,t){if(Array.isArray(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!E(e))||d.test(e)||!b.test(e)||null!=t&&e in Object(t)}function E(e){return"symbol"==typeof e||!!e&&"object"==typeof e&&"[object Symbol]"==Object.prototype.toString.call(e)}function F(e){return Array.isArray(e)?e:A(e)}var A=o.default(function(e){e=function(e){if(null==e)return"";if("string"==typeof e)return e;if(E(e))return Symbol.prototype.toString.call(e);var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t}(e);var t=[];return O.test(e)&&t.push(""),e.replace(w,function(e,r,n,o){t.push(n?o.replace(j,"$1"):r||e)}),t}),I=["suspense"],C=Symbol("ibizaIsAccessor"),M=Symbol("ibizaIsQuery"),V=Symbol("ibizaQueryFunction"),N=/*#__PURE__*/y("setListeners"),T=/*#__PURE__*/y("state"),q=/*#__PURE__*/y("proxyCache"),W=/*#__PURE__*/y("mergedObjects"),D=/*#__PURE__*/y("customFetchFn"),$=/*#__PURE__*/y("defaultFetchFn"),G=/*#__PURE__*/y("proxyOf");function H(e,t){var r=this;if(void 0===t&&(t=null),e.isHookProxy)return e;if(v(this,q)[q].has(e))return v(this,q)[q].get(e);function n(e){return e?0===e.indexOf("/")?e:t?[t,e].join("."):e:t}var o=this,u=new Proxy(e,{get:function(e,u,c){var s,f;if("isProxy"===u)return!0;if("isStoreProxy"===u)return!0;if("isHookProxy"===u)return!1;if("__path"===u)return t;if("__fetcher"===u)return function(e){if(0!==e.indexOf("/")){var t=n(e);0===t.indexOf("/")&&(e=t.split(".")[0])}if(Object.prototype.hasOwnProperty.call(r.fetches,e))return r.fetches[e]}(t);if("__raw"===u)return t?x(o.rawState,t):o.rawState;if("save"===u){var a=n(u);if(0===a.indexOf("/"))return function(e,t){void 0===e&&(e={}),void 0===t&&(t={});try{if("string"!=typeof e){t=e;var r=a.split(".");e=r[0]}return Promise.resolve(o.fetch(e,i({method:"patch"},t))).then(function(t){return null!==t&&(o.state[e]=t),t})}catch(e){return Promise.reject(e)}}}if("refetch"===u){var l=n(u);if(0===l.indexOf("/"))return function(){try{var e=l.split(".")[0];return Promise.resolve(o.fetch(e)).then(function(t){return null!==t&&(o.state[e]=t),t})}catch(e){return Promise.reject(e)}}}if("length"!==u&&!Object.prototype.hasOwnProperty.call(e,u)&&(Object.getPrototypeOf(e)[u]||"symbol"==typeof u))return Reflect.get(e,u,c);var p=n(u),h=Reflect.get(e,u,c);if(Object.isFrozen(e)||null!==h&&"object"==typeof h&&Object.isFrozen(h))return h;var y=function(e){return!Object.prototype.hasOwnProperty.call(o.fetches,e)||o.fetches[e].fetch},b=function(e){if(Object.prototype.hasOwnProperty.call(o.fetches,e)&&o.fetches[e].error)throw o.fetches[u].error};if(null!=(s=h)&&s[C])return h(e,u,c);if(null!=(f=h)&&f[M]){var d=h[V].call(c);if(b(d),y(d)){var O=o.fetch(d,{suspense:!0});Object.defineProperty(O,M,{value:!0}),Object.defineProperty(O,V,{value:h[V]}),this.set(e,u,O,c),h=O}else Object.prototype.hasOwnProperty.call(o.fetches,d)&&(h=o.fetches[d].response)}else if(0===u.indexOf("/"))b(u),y(u)&&(h=o.fetch(u,{suspense:!0}),this.set(e,u,h,c));else if(0===p.indexOf("/")){var g=p.split("."),j=g[0],w=g.slice(1).join(".");if(b(j),y(j)){var P=o.fetch(j,{suspense:!0});o.state[j]=P,h=x(P,w)}}return null===h||"object"!=typeof h||m(h)?h:v(o,G)[G](h,p)},set:function(e,t,r,i){if(e.isProxy&&console.warn("[ibiza] Attempting to set a property (%s) on proxied object",t,e),Object.isFrozen(e))throw new TypeError("Cannot mutate '"+t+"'. Object is frozen!");var u=Reflect.get(e,t,i),c=Reflect.set(e,t,r,i);if(c&&(u=L(u),"length"===t||!Object.is(u,r))){var s=n(t);K.debug&&(console.groupCollapsed("[ibiza] Mutated %o",s),console.info({previousValue:u,value:r}),console.groupEnd()),o.publishChange({target:e,prop:t,path:s,previousValue:u,value:r})}return c},deleteProperty:function(e,t){var r=Reflect.get(e,t),i=Reflect.deleteProperty(e,t);return i&&o.publishChange({target:e,prop:t,path:n(t),previousValue:L(r)}),i}});return v(this,q)[q].set(e,u),u}var K=new(/*#__PURE__*/function(){function e(){Object.defineProperty(this,G,{value:H}),this.debug="development"===process.env.NODE_ENV,this.fetches={},this.modelInitializers={},this.modelOptions={},Object.defineProperty(this,N,{writable:!0,value:new Set}),Object.defineProperty(this,T,{writable:!0,value:{}}),Object.defineProperty(this,q,{writable:!0,value:new WeakMap}),Object.defineProperty(this,W,{writable:!0,value:new WeakMap}),Object.defineProperty(this,D,{writable:!0,value:void 0}),Object.defineProperty(this,$,{writable:!0,value:function(e,t){var r=/*#__PURE__*/function(e){var t,r;function n(){return e.apply(this,arguments)||this}return r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,c(t,r),n}(/*#__PURE__*/a(Error)),n=new URL(e,location.origin);return fetch(new Request(n),t).then(function(e){if(!e.ok)throw new r(e.statusText);return 204===e.status?null:e.json()})}}),this.reset()}var t,r,n=e.prototype;return n.merge=function(e){if(!P(e))throw new TypeError("IbizaStore#merge expects a plain object to merge");v(this,W)[W].has(e)||(v(this,W)[W].set(e,!0),Q(this.state,e))},n.listenForChanges=function(e){var t=this;return v(this,N)[N].add(e),function(){return t.unlistenForChanges(e)}},n.unlistenForChanges=function(e){v(this,N)[N].delete(e)},n.publishChange=function(){for(var e,t=p(v(this,N)[N]);!(e=t()).done;){var r=e.value;r.apply(void 0,arguments)}},n.reset=function(){v(this,T)[T]={},v(this,W)[W]=new WeakMap,v(this,q)[q]=new WeakMap,v(this,D)[D]=void 0,v(this,N)[N]=new Set,this.fetches={},this.modelInitializers={},this.modelOptions={},this.debug="development"===process.env.NODE_ENV},n.fetch=function(e,t){var r,n=this;void 0===t&&(t={});var o=t.suspense,i=function(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(o[r]=e[r]);return o}(t,I),u=function(t){return n.fetches[e].status="success",null===t?t:n.fetches[e].response=e in n.modelInitializers?n.modelInitializers[e](t):t},c=((null==(r=this.modelOptions[e])?void 0:r.fetcher)||this.fetchFn).bind(this.state);if(!o)return c(e,i).then(u);if(this.fetches[e]){if(this.fetches[e].error)throw delete this.fetches[e].fetch,this.fetches[e].error;if(this.fetches[e].response)return delete this.fetches[e].fetch,this.fetches[e].response}else this.fetches[e]={status:"start",fetch:c(e,i).then(u).catch(function(t){n.fetches[e].status="error",n.fetches[e].error=t})};throw this.fetches[e].fetch},t=e,(r=[{key:"state",get:function(){return v(this,G)[G](v(this,T)[T])},set:function(e){v(this,q)[q]=new WeakMap,v(this,T)[T]=e}},{key:"rawState",get:function(){return v(this,T)[T]}},{key:"fetchFn",get:function(){return v(this,D)[D]||v(this,$)[$]},set:function(e){v(this,D)[D]=e}}])&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}()),B=K;function L(e){return e&&e.isProxy?e.__path?x(K.rawState,e.__path):K.rawState:e}function Q(e,t){for(var r=0,n=Object.keys(t);r<n.length;r++){var o=n[r],i=Object.getOwnPropertyDescriptor(t,o),u=Object.prototype.hasOwnProperty.call(i,"value");if(Object.prototype.hasOwnProperty.call(e,o)?(u&&"object"!=typeof i.value||Array.isArray(i.value))&&Object.defineProperty(e,o,i):Object.defineProperty(e,o,i),u){var c=e[o];P(i.value)?e[o]=Q(c,i.value):Array.isArray(i.value)&&(e[o]=i.value.map(function(e,t,r){return P(e)?Q(r[t],e):e}))}}return e}function U(e,t,r,n,o){var i;if("string"==typeof e?(i=x(B.state,e)||{},t=e):i=e||B.state,n.has(i))return n.get(i);if(null===i)return i;if(i.isHookProxy)return i;var u=new Proxy(i,{get:function(e,o){if("isProxy"===o)return!0;if("isStoreProxy"===o)return!1;if("isHookProxy"===o)return!0;if("$root"===o)return U(null,null,r,n);if("$model"===o){var i=c(o).split("."),u=i[0];return U(u,null,r,n)}var s=Object.prototype.hasOwnProperty.call(e,o),f=Reflect.get.apply(Reflect,arguments);if(Object.isFrozen(e)||null!==f&&"object"==typeof f&&Object.isFrozen(f))return L(f);if("__path"===o||"save"===o&&"function"==typeof f)return f;if("length"!==o&&!s&&(Object.getPrototypeOf(e)[o]||"symbol"==typeof o))return f;if("function"==typeof f&&s)return f.bind(U(e,t,r,n),U(null,null,r,n));var a=c(o);return null===f||"object"!=typeof f||m(f)?(r(a,"get"),f):U(f,a,r,n)},ownKeys:function(){return r(c(),"ownKeys"),Reflect.ownKeys.apply(Reflect,arguments)}});function c(e){return e?0===e.indexOf("/")?e:t?[t,e].join("."):e:t}return n.set(i,u),u}function Y(t,r){var n=function(){var t=e.useRef();if("production"!==process.env.NODE_ENV){var r=(new Error).stack.split("\n").find(function(e){return/^[A-Z]/.test(e.trim().split(" ")[1])});t.current=null==r?void 0:r.trim().split(" ")[1]}return t}(),o=e.useReducer(function(e){return e+1},0)[1],i=e.useRef([]),u=e.useRef(new WeakMap),c=e.useRef(t),s=e.useRef(),f=e.useCallback(function(e){var t=e.path,r=e.previousValue,u=e.value,c=function(e,t){if(t.includes(e))return"exact";for(var r,n=!1,o=p(t);!(r=o()).done;){var i=r.value;if(e.startsWith(i)){n="child";break}if(i.startsWith(e+".")){n="parent";break}}return n}(t,i.current);if(c)if("parent"===c){var s=Z(t,i.current,u,r);s&&(B.debug&&console.debug("[ibiza] <%s> rerendering on child %o of %o",n.current,s,t),o())}else B.debug&&console.debug("[ibiza] <%s> rerendering on %o (%s)",n.current,t,c),o()},[]),a=e.useCallback(function(e){i.current.includes(e)||(B.debug&&console.debug("[ibiza] <%s> tracking %o",n.current,e),i.current.push(e),B.listenForChanges(f))},[n,f]);if(void 0!==typeof c.current)if(P(c.current))B.merge(c.current),c.current=void 0;else if("function"==typeof c.current)B.merge(c.current(B.state)),c.current=void 0;else if("string"==typeof c.current){var l;s.current=c.current,c.current=void 0,r&&(l=0===s.current.indexOf("/")?"function"==typeof r?{}:r:"function"==typeof r?r(x(B.state,s.current)||{}):r,B.merge(function(e,t,r){if(null==e)return e;if(!_(e))return e;for(var n=-1,o=e,i=(t=R(t,e)?[t]:F(t)).length,u=i-1;null!=o&&++n<i;){var c=k(t[n]),s=r;if(n!=u){var f=o[c];s=_(f)?f:z(t[n+1])?[]:{}}S(o,c,s),o=o[c]}return e}({},s.current,l)))}e.useEffect(function(){return function(){return B.unlistenForChanges(f)}},[]);var h=e.useMemo(function(){var e=null,t=null;if(s.current){var r=x(B.state,e=s.current);if(null!=r&&"object"!=typeof r&&"function"!=typeof r){var n=e.split(".").reverse();t=n[0],e=n.slice(1).reverse().join(".")||null}}return[e,t]},[]),y=h[1],v=U(h[0]||null,null,a,u.current);return y?v[y]:v}"production"!==process.env.NODE_ENV&&(window.ibizaStore=K);var Z=o.default(function(e,t,n,o){return t.find(function(t){if(!t.startsWith(e+"."))return!1;var i=t.slice(e.length+1),u=i.includes("."),c=void 0;null!=n&&(c=u?x(n,i):n[i]);var s=void 0;return null!=o&&(s=u?x(o,i):o[i]),m(c)&&m(s)?c.getTime()!==s.getTime():"object"==typeof s&&"object"==typeof c?!r.deepEqual(c,s):!Object.is(c,s)})},{isEqual:r.deepEqual,maxSize:Number.POSITIVE_INFINITY});exports.accessor=function(e){function t(t,r,n){var o=!1,i=e.initialValue,u=function(e){i=e,o=!0};return Object.defineProperty(t,r,{get:function(){return e.onGet?e.onGet.call(this,i):i},set:function(t){var r;null==(r=e.onSet)||r.call(this,i,t,u),o?o=!1:i=t}}),Reflect.get(t,r,n)}return void 0===e&&(e={}),Object.defineProperty(t,C,{value:!0}),t},exports.createAccessor=function(e,t,r){void 0===r&&(r={});var n=!1,o=Object.prototype.hasOwnProperty.call(e,t)?e[t]:r.initialValue,i=function(e){o=e,n=!0};Object.defineProperty(e,t,{get:function(){return r.onGet?r.onGet.call(this,o):o},set:function(e){var t;null==(t=r.onSet)||t.call(this,o,e,i),n?n=!1:o=e}})},exports.createModel=function(t,r,n){return void 0===r&&(r={}),void 0===n&&(n={}),function(o,i){if(e.useDebugValue(t),"string"!=typeof o&&(i=o,o=void 0),t in B.state==0)if("function"==typeof r){var u=B.modelInitializers[t]=function(e){return r(e,i)};0!==t.indexOf("/")&&(B.state[t]=u(B.state[t]))}else B.state[t]=r;return B.modelOptions[t]=n,Y(o?[t,o].join("."):t)}},exports.freeze=function e(t){if(Object.isFrozen(t))return t;if(!Array.isArray(t)&&Object.getPrototypeOf(t)!==Object.getPrototypeOf({}))throw new Error("Ibiza#freeze only supports plain objects, arrays, and primitives");return Object.freeze(t),Object.keys(t).forEach(function(r){e(t[r])}),t},exports.query=function(e){var t={};return Object.defineProperty(t,M,{value:!0}),Object.defineProperty(t,V,{value:e}),t},exports.rawStateOf=L,exports.store=B,exports.useIbiza=Y;
//# sourceMappingURL=ibiza.cjs.map
