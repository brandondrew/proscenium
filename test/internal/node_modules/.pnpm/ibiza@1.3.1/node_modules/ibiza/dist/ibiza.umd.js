!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("micro-memoize"),require("fast-equals")):"function"==typeof define&&define.amd?define(["exports","react","micro-memoize","fast-equals"],t):t((e||self).ibiza={},e.react,e.microMemoize,e.fastEquals)}(this,function(e,t,r,n){function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i=/*#__PURE__*/o(r);function u(){return u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},u.apply(this,arguments)}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function f(e,t){return f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},f(e,t)}function s(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function a(e,t,r){return a=s()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var o=new(Function.bind.apply(e,n));return r&&f(o,r.prototype),o},a.apply(null,arguments)}function l(e){var t="function"==typeof Map?new Map:void 0;return l=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return a(e,arguments,c(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),f(r,e)},l(e)}function p(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function h(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return p(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?p(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var y=0;function v(e){return"__private_"+y+++"_"+e}function b(e,t){if(!Object.prototype.hasOwnProperty.call(e,t))throw new TypeError("attempted to use private field on non-instance");return e}var d=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,O=/^\w*$/,g=/^\./,j=/^(?:0|[1-9]\d*)$/,m=/\\(\\)?/g,w=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g;function P(e){return"[object Date]"===Object.prototype.toString.call(e)}function x(e){if("[object Object]"!==Object.prototype.toString.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function z(e,t){for(var r=0,n=(t=R(t,e)?[t]:A(t)).length;null!=e&&r<n;)e=e[E(t[r++])];return r&&r==n?e:void 0}function S(e,t,r){var n=e[t];Object.prototype.hasOwnProperty.call(e,t)&&function(e,t){return e===t||e!=e&&t!=t}(n,r)&&(void 0!==r||t in e)||(e[t]=r)}function _(e,t){return!!(t=null==t?9007199254740991:t)&&("number"==typeof e||j.test(e))&&e>-1&&e%1==0&&e<t}function k(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function E(e){if("string"==typeof e||F(e))return e;var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t}function R(e,t){if(Array.isArray(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!F(e))||O.test(e)||!d.test(e)||null!=t&&e in Object(t)}function F(e){return"symbol"==typeof e||!!e&&"object"==typeof e&&"[object Symbol]"==Object.prototype.toString.call(e)}function A(e){return Array.isArray(e)?e:I(e)}var I=i.default(function(e){e=function(e){if(null==e)return"";if("string"==typeof e)return e;if(F(e))return Symbol.prototype.toString.call(e);var t=e+"";return"0"==t&&1/e==-Infinity?"-0":t}(e);var t=[];return g.test(e)&&t.push(""),e.replace(w,function(e,r,n,o){t.push(n?o.replace(m,"$1"):r||e)}),t}),C=["suspense"],M=Symbol("ibizaIsAccessor"),T=Symbol("ibizaIsQuery"),V=Symbol("ibizaQueryFunction"),q=/*#__PURE__*/v("setListeners"),N=/*#__PURE__*/v("state"),W=/*#__PURE__*/v("proxyCache"),D=/*#__PURE__*/v("mergedObjects"),$=/*#__PURE__*/v("customFetchFn"),G=/*#__PURE__*/v("defaultFetchFn"),H=/*#__PURE__*/v("proxyOf"),K=/*#__PURE__*/function(){function e(){Object.defineProperty(this,H,{value:B}),this.debug="development"===process.env.NODE_ENV,this.fetches={},this.modelInitializers={},this.modelOptions={},Object.defineProperty(this,q,{writable:!0,value:new Set}),Object.defineProperty(this,N,{writable:!0,value:{}}),Object.defineProperty(this,W,{writable:!0,value:new WeakMap}),Object.defineProperty(this,D,{writable:!0,value:new WeakMap}),Object.defineProperty(this,$,{writable:!0,value:void 0}),Object.defineProperty(this,G,{writable:!0,value:function(e,t){var r=/*#__PURE__*/function(e){var t,r;function n(){return e.apply(this,arguments)||this}return r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,f(t,r),n}(/*#__PURE__*/l(Error)),n=new URL(e,location.origin);return fetch(new Request(n),t).then(function(e){if(!e.ok)throw new r(e.statusText);return 204===e.status?null:e.json()})}}),this.reset()}var t,r,n=e.prototype;return n.merge=function(e){if(!x(e))throw new TypeError("IbizaStore#merge expects a plain object to merge");b(this,D)[D].has(e)||(b(this,D)[D].set(e,!0),Y(this.state,e))},n.listenForChanges=function(e){var t=this;return b(this,q)[q].add(e),function(){return t.unlistenForChanges(e)}},n.unlistenForChanges=function(e){b(this,q)[q].delete(e)},n.publishChange=function(){for(var e,t=h(b(this,q)[q]);!(e=t()).done;){var r=e.value;r.apply(void 0,arguments)}},n.reset=function(){b(this,N)[N]={},b(this,D)[D]=new WeakMap,b(this,W)[W]=new WeakMap,b(this,$)[$]=void 0,b(this,q)[q]=new Set,this.fetches={},this.modelInitializers={},this.modelOptions={},this.debug="development"===process.env.NODE_ENV},n.fetch=function(e,t){var r,n=this;void 0===t&&(t={});var o=t.suspense,i=function(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t.indexOf(r=i[n])>=0||(o[r]=e[r]);return o}(t,C),u=function(t){return n.fetches[e].status="success",null===t?t:n.fetches[e].response=e in n.modelInitializers?n.modelInitializers[e](t):t},c=((null==(r=this.modelOptions[e])?void 0:r.fetcher)||this.fetchFn).bind(this.state);if(!o)return c(e,i).then(u);if(this.fetches[e]){if(this.fetches[e].error)throw delete this.fetches[e].fetch,this.fetches[e].error;if(this.fetches[e].response)return delete this.fetches[e].fetch,this.fetches[e].response}else this.fetches[e]={status:"start",fetch:c(e,i).then(u).catch(function(t){n.fetches[e].status="error",n.fetches[e].error=t})};throw this.fetches[e].fetch},t=e,(r=[{key:"state",get:function(){return b(this,H)[H](b(this,N)[N])},set:function(e){b(this,W)[W]=new WeakMap,b(this,N)[N]=e}},{key:"rawState",get:function(){return b(this,N)[N]}},{key:"fetchFn",get:function(){return b(this,$)[$]||b(this,G)[G]},set:function(e){b(this,$)[$]=e}}])&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();function B(e,t){var r=this;if(void 0===t&&(t=null),e.isHookProxy)return e;if(b(this,W)[W].has(e))return b(this,W)[W].get(e);function n(e){return e?0===e.indexOf("/")?e:t?[t,e].join("."):e:t}var o=this,i=new Proxy(e,{get:function(e,i,c){var f,s;if("isProxy"===i)return!0;if("isStoreProxy"===i)return!0;if("isHookProxy"===i)return!1;if("__path"===i)return t;if("__fetcher"===i)return function(e){if(0!==e.indexOf("/")){var t=n(e);0===t.indexOf("/")&&(e=t.split(".")[0])}if(Object.prototype.hasOwnProperty.call(r.fetches,e))return r.fetches[e]}(t);if("__raw"===i)return t?z(o.rawState,t):o.rawState;if("save"===i){var a=n(i);if(0===a.indexOf("/"))return function(e,t){void 0===e&&(e={}),void 0===t&&(t={});try{if("string"!=typeof e){t=e;var r=a.split(".");e=r[0]}return Promise.resolve(o.fetch(e,u({method:"patch"},t))).then(function(t){return null!==t&&(o.state[e]=t),t})}catch(e){return Promise.reject(e)}}}if("refetch"===i){var l=n(i);if(0===l.indexOf("/"))return function(){try{var e=l.split(".")[0];return Promise.resolve(o.fetch(e)).then(function(t){return null!==t&&(o.state[e]=t),t})}catch(e){return Promise.reject(e)}}}if("length"!==i&&!Object.prototype.hasOwnProperty.call(e,i)&&(Object.getPrototypeOf(e)[i]||"symbol"==typeof i))return Reflect.get(e,i,c);var p=n(i),h=Reflect.get(e,i,c);if(Object.isFrozen(e)||null!==h&&"object"==typeof h&&Object.isFrozen(h))return h;var y=function(e){return!Object.prototype.hasOwnProperty.call(o.fetches,e)||o.fetches[e].fetch},v=function(e){if(Object.prototype.hasOwnProperty.call(o.fetches,e)&&o.fetches[e].error)throw o.fetches[i].error};if(null!=(f=h)&&f[M])return h(e,i,c);if(null!=(s=h)&&s[T]){var d=h[V].call(c);if(v(d),y(d)){var O=o.fetch(d,{suspense:!0});Object.defineProperty(O,T,{value:!0}),Object.defineProperty(O,V,{value:h[V]}),this.set(e,i,O,c),h=O}else Object.prototype.hasOwnProperty.call(o.fetches,d)&&(h=o.fetches[d].response)}else if(0===i.indexOf("/"))v(i),y(i)&&(h=o.fetch(i,{suspense:!0}),this.set(e,i,h,c));else if(0===p.indexOf("/")){var g=p.split("."),j=g[0],m=g.slice(1).join(".");if(v(j),y(j)){var w=o.fetch(j,{suspense:!0});o.state[j]=w,h=z(w,m)}}return null===h||"object"!=typeof h||P(h)?h:b(o,H)[H](h,p)},set:function(e,t,r,i){if(e.isProxy&&console.warn("[ibiza] Attempting to set a property (%s) on proxied object",t,e),Object.isFrozen(e))throw new TypeError("Cannot mutate '"+t+"'. Object is frozen!");var u=Reflect.get(e,t,i),c=Reflect.set(e,t,r,i);if(c&&(u=U(u),"length"===t||!Object.is(u,r))){var f=n(t);L.debug&&(console.groupCollapsed("[ibiza] Mutated %o",f),console.info({previousValue:u,value:r}),console.groupEnd()),o.publishChange({target:e,prop:t,path:f,previousValue:u,value:r})}return c},deleteProperty:function(e,t){var r=Reflect.get(e,t),i=Reflect.deleteProperty(e,t);return i&&o.publishChange({target:e,prop:t,path:n(t),previousValue:U(r)}),i}});return b(this,W)[W].set(e,i),i}var L=new K,Q=L;function U(e){return e&&e.isProxy?e.__path?z(L.rawState,e.__path):L.rawState:e}function Y(e,t){for(var r=0,n=Object.keys(t);r<n.length;r++){var o=n[r],i=Object.getOwnPropertyDescriptor(t,o),u=Object.prototype.hasOwnProperty.call(i,"value");if(Object.prototype.hasOwnProperty.call(e,o)?(u&&"object"!=typeof i.value||Array.isArray(i.value))&&Object.defineProperty(e,o,i):Object.defineProperty(e,o,i),u){var c=e[o];x(i.value)?e[o]=Y(c,i.value):Array.isArray(i.value)&&(e[o]=i.value.map(function(e,t,r){return x(e)?Y(r[t],e):e}))}}return e}function Z(e,t,r,n,o){var i;if("string"==typeof e?(i=z(Q.state,e)||{},t=e):i=e||Q.state,n.has(i))return n.get(i);if(null===i)return i;if(i.isHookProxy)return i;var u=new Proxy(i,{get:function(e,o){if("isProxy"===o)return!0;if("isStoreProxy"===o)return!1;if("isHookProxy"===o)return!0;if("$root"===o)return Z(null,null,r,n);if("$model"===o){var i=c(o).split("."),u=i[0];return Z(u,null,r,n)}var f=Object.prototype.hasOwnProperty.call(e,o),s=Reflect.get.apply(Reflect,arguments);if(Object.isFrozen(e)||null!==s&&"object"==typeof s&&Object.isFrozen(s))return U(s);if("__path"===o||"save"===o&&"function"==typeof s)return s;if("length"!==o&&!f&&(Object.getPrototypeOf(e)[o]||"symbol"==typeof o))return s;if("function"==typeof s&&f)return s.bind(Z(e,t,r,n),Z(null,null,r,n));var a=c(o);return null===s||"object"!=typeof s||P(s)?(r(a,"get"),s):Z(s,a,r,n)},ownKeys:function(){return r(c(),"ownKeys"),Reflect.ownKeys.apply(Reflect,arguments)}});function c(e){return e?0===e.indexOf("/")?e:t?[t,e].join("."):e:t}return n.set(i,u),u}function J(e,r){var n=function(){var e=t.useRef();if("production"!==process.env.NODE_ENV){var r=(new Error).stack.split("\n").find(function(e){return/^[A-Z]/.test(e.trim().split(" ")[1])});e.current=null==r?void 0:r.trim().split(" ")[1]}return e}(),o=t.useReducer(function(e){return e+1},0)[1],i=t.useRef([]),u=t.useRef(new WeakMap),c=t.useRef(e),f=t.useRef(),s=t.useCallback(function(e){var t=e.path,r=e.previousValue,u=e.value,c=function(e,t){if(t.includes(e))return"exact";for(var r,n=!1,o=h(t);!(r=o()).done;){var i=r.value;if(e.startsWith(i)){n="child";break}if(i.startsWith(e+".")){n="parent";break}}return n}(t,i.current);if(c)if("parent"===c){var f=X(t,i.current,u,r);f&&(Q.debug&&console.debug("[ibiza] <%s> rerendering on child %o of %o",n.current,f,t),o())}else Q.debug&&console.debug("[ibiza] <%s> rerendering on %o (%s)",n.current,t,c),o()},[]),a=t.useCallback(function(e){i.current.includes(e)||(Q.debug&&console.debug("[ibiza] <%s> tracking %o",n.current,e),i.current.push(e),Q.listenForChanges(s))},[n,s]);if(void 0!==typeof c.current)if(x(c.current))Q.merge(c.current),c.current=void 0;else if("function"==typeof c.current)Q.merge(c.current(Q.state)),c.current=void 0;else if("string"==typeof c.current){var l;f.current=c.current,c.current=void 0,r&&(l=0===f.current.indexOf("/")?"function"==typeof r?{}:r:"function"==typeof r?r(z(Q.state,f.current)||{}):r,Q.merge(function(e,t,r){if(null==e)return e;if(!k(e))return e;for(var n=-1,o=e,i=(t=R(t,e)?[t]:A(t)).length,u=i-1;null!=o&&++n<i;){var c=E(t[n]),f=r;if(n!=u){var s=o[c];f=k(s)?s:_(t[n+1])?[]:{}}S(o,c,f),o=o[c]}return e}({},f.current,l)))}t.useEffect(function(){return function(){return Q.unlistenForChanges(s)}},[]);var p=t.useMemo(function(){var e=null,t=null;if(f.current){var r=z(Q.state,e=f.current);if(null!=r&&"object"!=typeof r&&"function"!=typeof r){var n=e.split(".").reverse();t=n[0],e=n.slice(1).reverse().join(".")||null}}return[e,t]},[]),y=p[1],v=Z(p[0]||null,null,a,u.current);return y?v[y]:v}"production"!==process.env.NODE_ENV&&(window.ibizaStore=L);var X=i.default(function(e,t,r,o){return t.find(function(t){if(!t.startsWith(e+"."))return!1;var i=t.slice(e.length+1),u=i.includes("."),c=void 0;null!=r&&(c=u?z(r,i):r[i]);var f=void 0;return null!=o&&(f=u?z(o,i):o[i]),P(c)&&P(f)?c.getTime()!==f.getTime():"object"==typeof f&&"object"==typeof c?!n.deepEqual(c,f):!Object.is(c,f)})},{isEqual:n.deepEqual,maxSize:Number.POSITIVE_INFINITY});e.accessor=function(e){function t(t,r,n){var o=!1,i=e.initialValue,u=function(e){i=e,o=!0};return Object.defineProperty(t,r,{get:function(){return e.onGet?e.onGet.call(this,i):i},set:function(t){var r;null==(r=e.onSet)||r.call(this,i,t,u),o?o=!1:i=t}}),Reflect.get(t,r,n)}return void 0===e&&(e={}),Object.defineProperty(t,M,{value:!0}),t},e.createAccessor=function(e,t,r){void 0===r&&(r={});var n=!1,o=Object.prototype.hasOwnProperty.call(e,t)?e[t]:r.initialValue,i=function(e){o=e,n=!0};Object.defineProperty(e,t,{get:function(){return r.onGet?r.onGet.call(this,o):o},set:function(e){var t;null==(t=r.onSet)||t.call(this,o,e,i),n?n=!1:o=e}})},e.createModel=function(e,r,n){return void 0===r&&(r={}),void 0===n&&(n={}),function(o,i){if(t.useDebugValue(e),"string"!=typeof o&&(i=o,o=void 0),e in Q.state==0)if("function"==typeof r){var u=Q.modelInitializers[e]=function(e){return r(e,i)};0!==e.indexOf("/")&&(Q.state[e]=u(Q.state[e]))}else Q.state[e]=r;return Q.modelOptions[e]=n,J(o?[e,o].join("."):e)}},e.freeze=function e(t){if(Object.isFrozen(t))return t;if(!Array.isArray(t)&&Object.getPrototypeOf(t)!==Object.getPrototypeOf({}))throw new Error("Ibiza#freeze only supports plain objects, arrays, and primitives");return Object.freeze(t),Object.keys(t).forEach(function(r){e(t[r])}),t},e.query=function(e){var t={};return Object.defineProperty(t,T,{value:!0}),Object.defineProperty(t,V,{value:e}),t},e.rawStateOf=U,e.store=Q,e.useIbiza=J});
//# sourceMappingURL=ibiza.umd.js.map
